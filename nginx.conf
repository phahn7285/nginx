events {
    worker_connections 1024;
}

http {
    
    # WebSocket connection upgrade mapping
    map $http_upgrade $connection_upgrade {
        default upgrade;
        '' close;
    }

    upstream adminer {
        # Updated to reference the new service name "adminer"
        server adminer:8080;
    }
    
    upstream cadvisor {
        server cadvisor:8080;
    }
   
    upstream docker-api {                                                                                                       server docker-api:8000;                                                                                             }                                                                                                                   

    upstream docsify-server {
        server docsify-server:3000;
    }
    
    upstream kafka {
        server kafka:9092;
    }
    
    upstream kafka-ui {                                                                                                         server kafka-ui:8080;                                                                                               }                                                                                                                 

    upstream metabase {
        server metabase:3000;
    }

    upstream netdata {
        server netdata:19999;
    }

    upstream grafana {
        server paul-grafana-1:3000;
    }
    upstream loki {
        server paul-loki-1:3100;
    }
    upstream prometheus {
        server paul-prometheus-1:9090;
    }
    upstream service-control {
        server services-api:5000;
    }

    upstream polygonio-api {
        server polygonio-api:5001;
    }

    # Enable gzip compression
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/json
        application/javascript
        application/xml+rss
        application/atom+xml
        image/svg+xml;

    # MIME types
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # Logging
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';
    
    # Enhanced logging format with correlation ID for tracing
    log_format trace '$remote_addr - $remote_user [$time_local] "$request" '
                     '$status $body_bytes_sent "$http_referer" '
                     '"$http_user_agent" "$http_x_forwarded_for" '
                     'correlation_id="$http_x_correlation_id" '
                     'response_correlation_id="$upstream_http_x_correlation_id" '
                     'request_time=$request_time '
                     'upstream_response_time=$upstream_response_time';

    access_log /var/log/nginx/access.log trace;
    error_log /var/log/nginx/error.log warn;

    # Basic optimization
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;

    # Server configuration for DNS_DOMAIN_NAME
    server {
        listen 80;
        server_name ${DNS_DOMAIN_NAME};

        # Security headers
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header Referrer-Policy "no-referrer-when-downgrade" always;
        add_header Content-Security-Policy "default-src 'self' http: https: data: blob: 'unsafe-inline' 'unsafe-eval'" always;
        
        # Error pages
        error_page 404 /404.html;
        error_page 500 502 503 504 /50x.html;

        location = /404.html {
            return 404 '404 Not Found';
            add_header Content-Type text/plain;
        }

        location = /50x.html {
            return 500 '500 Internal Server Error';
            add_header Content-Type text/plain;
        }

        # CSS files - Adminer custom CSS
        location /adminer-custom.css {
            alias /var/www/css/adminer-custom.css;
            expires 7d;
            add_header Cache-Control "public";
            add_header Content-Type "text/css";
        }

        # API endpoints - Docker API endpoints - Proxy to docker-api service
        location /api/docker/ {
            proxy_pass http://docker-api/api/docker/;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            add_header Access-Control-Allow-Origin "*";
            add_header Access-Control-Allow-Methods "GET, POST, OPTIONS";
            add_header Access-Control-Allow-Headers "Content-Type";
            proxy_read_timeout 120s;  # Longer timeout for build operations
            proxy_connect_timeout 10s;
        }

        # API endpoints - Kafka Multi Messages API - Proxy to kafka-api service
	location /api/kafka/ {
	    # Keep the full original path so /api/kafka/multi-messages-and-offsets
	    # is sent unchanged to the kafka-api service
	    proxy_pass http://kafka-api:8000;

	    proxy_http_version 1.1;
	    proxy_set_header Host $host;
	    proxy_set_header X-Real-IP $remote_addr;
	    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
	    proxy_set_header X-Forwarded-Proto $scheme;

	    add_header Access-Control-Allow-Origin "*";
	    add_header Access-Control-Allow-Methods "GET, POST, OPTIONS";
	    add_header Access-Control-Allow-Headers "Content-Type";

	    proxy_read_timeout 60s;
	    proxy_connect_timeout 10s;
	}

	# API endpoints - Kafka Topics API - Proxy to kafka-api service
        location = /api/kafka-topics {
            proxy_pass http://kafka-api:8000/api/kafka-topics;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            add_header Access-Control-Allow-Origin "*";
            add_header Access-Control-Allow-Methods "GET, POST, OPTIONS";
            add_header Access-Control-Allow-Headers "Content-Type";
            proxy_read_timeout 60s;
            proxy_connect_timeout 10s;
        }
        
        location /api/kafka-topics/ {
            proxy_pass http://kafka-api:8000/api/kafka-topics/;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            add_header Access-Control-Allow-Origin "*";
            add_header Access-Control-Allow-Methods "GET, POST, OPTIONS";
            add_header Access-Control-Allow-Headers "Content-Type";
            proxy_read_timeout 60s;
            proxy_connect_timeout 10s;
        }

        # API endpoints - Stock Services API - Proxy to polygonio service
        location /api/stock-services {
            proxy_pass http://polygonio-api/api/stock-services;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            add_header Access-Control-Allow-Origin "*";
            add_header Access-Control-Allow-Methods "GET, POST, OPTIONS";
            add_header Access-Control-Allow-Headers "Content-Type";
            proxy_read_timeout 60s;
            proxy_connect_timeout 10s;
        }

        # cAdvisor - Proxy to internal service
        location /cadvisor {
            proxy_pass http://cadvisor/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # CSS files - Static file serving for custom CSS files
        location /css/ {
            alias /var/www/css/;
            expires 7d;
            add_header Cache-Control "public";
            add_header Access-Control-Allow-Origin "*";
            add_header Content-Type "text/css";
        }

        # Health check
        location /health {
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }

        # React routing - handle health-dashboard and internal React routes
        location ~ ^/(health-dashboard)(/.*)?$ {
            proxy_pass http://react-app:3001;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }

        # Icons - Static file serving for icons
        location /icons/ {
            alias /var/www/icons/;
            expires 7d;
            add_header Cache-Control "public";
            add_header Access-Control-Allow-Origin "*";
        }

        # Kafka - Proxy to internal service
        location /kafka {
            proxy_pass http://kafka/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Kafka UI - completely new simple approach
        location ~ ^/kafka($|/.*) {
            # Strip /kafka prefix and pass everything else
            rewrite ^/kafka/?(.*)$ /$1 break;
            
            proxy_pass http://kafka-ui;
            proxy_redirect off;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Prefix /kafka;
            
            # Disable compression for sub_filter
            proxy_set_header Accept-Encoding "";
            
            # Inject our custom CSS into Kafka UI pages
            sub_filter '</head>' '<link rel="stylesheet" type="text/css" href="/css/kafka-custom.css"></head>';
            
            # Rewrite asset paths in HTML
            sub_filter 'window.basePath = \'\';' 'window.basePath = \'/kafka\';';
            sub_filter '="/assets/' '="/kafka/assets/';
            sub_filter "url('/fonts/" "url('/kafka/fonts/";
            
            sub_filter_once off;
        }

        # Metabase - analytics UI
        location /metabase/ {
            proxy_pass http://metabase/;

            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header X-Forwarded-Prefix /metabase;

            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
        }

        # Health endpoint for Metabase
        location /metabase/health {
            proxy_pass http://metabase/api/health;
            proxy_set_header Host $host;
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Grafana - analytics and dashboards (proxy to Grafana container)
        location ~ ^/grafana($|/.*) {
            rewrite ^/grafana/?(.*)$ /$1 break;
            proxy_pass http://grafana;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Prefix /grafana;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
        }

        # Loki - log aggregation UI
        location ~ ^/loki($|/.*) {
            rewrite ^/loki/?(.*)$ /$1 break;
            proxy_pass http://loki;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Prefix /loki;
        }

        # Prometheus - metrics UI
        location ~ ^/prometheus($|/.*) {
            rewrite ^/prometheus/?(.*)$ /$1 break;
            proxy_pass http://prometheus;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Prefix /prometheus;
        }

        # Docsify documentation - serve all files under /docs via docsify-server
        location /docs/ {
            rewrite ^/docs/?(.*)$ /$1 break;
            proxy_pass http://docsify-server/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Prefix /docs;
        }
        location = /docs {
            return 301 /docs/;
        }

        # Service control API (services-api: Butterfly, Docker, React App, Samba; Nginx cache-clear)
        location /api/service-control/ {
            proxy_pass http://service-control/;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_read_timeout 60s;
            proxy_connect_timeout 10s;
        }

	# MySQL Database Admin UI - Simple proxy to Adminer with CSS injection
        location ~ ^/mysql($|/.*) {
            # Strip /mysql prefix and pass everything else
            rewrite ^/mysql/?(.*)$ /$1 break;
            
            proxy_pass http://adminer;
            proxy_redirect off;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Prefix /mysql;
            
            # Disable compression for sub_filter
            proxy_set_header Accept-Encoding "";
            
            # Inject our custom CSS into Adminer pages
            sub_filter '</head>' '<link rel="stylesheet" type="text/css" href="/css/adminer-custom.css"></head>';
            
            # Rewrite asset paths in HTML for Adminer
            sub_filter '="/' '="/mysql/';
            sub_filter "url('/" "url('/mysql/";
            sub_filter 'href="/' 'href="/mysql/';
            sub_filter 'src="/' 'src="/mysql/';
            sub_filter_once off;
        }

        # Netdata - convenience redirect
        location = /netdata {
            return 301 /netdata/;
        }

        # Netdata - main UI and API
        location ~ ^/netdata/(?<ndpath>.*)$ {
            proxy_redirect off;

            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $host;

            proxy_http_version 1.1;
            proxy_set_header Connection "keep-alive";

            proxy_pass http://netdata/$ndpath$is_args$args;

            # Netdata docs recommend disabling buffering / caching for live charts
            proxy_store off;
            proxy_buffering off;
            proxy_cache off;
        }
	
        # Polygon.io Service - Proxy to internal service with comprehensive error handling
        location ~ ^/api/polygonio($|/.*) {
            # Strip /polygonio prefix and pass everything else
            rewrite ^/api/polygonio/?(.*)$ /$1 break;
            
            proxy_pass http://polygonio-api;
            proxy_redirect off;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Prefix /polygonio;
            
            # Pass correlation ID and request timing headers
            proxy_set_header X-Correlation-ID $http_x_correlation_id;
            proxy_set_header X-Request-Start $msec;
            proxy_set_header X-Service "polygonio-api";
            
            # Proxy timeouts and buffer settings
            proxy_connect_timeout 10s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
            proxy_buffering on;
            proxy_buffer_size 4k;
            proxy_buffers 8 4k;
            proxy_busy_buffers_size 8k;
            
            # Error handling - map upstream errors
            proxy_intercept_errors on;
            error_page 502 503 504 = @polygonio_error;
            
            # CORS headers for API access
            add_header Access-Control-Allow-Origin "*" always;
            add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
            add_header Access-Control-Allow-Headers "Content-Type, X-Correlation-ID" always;
            
            # Handle preflight requests
            if ($request_method = 'OPTIONS') {
                add_header Access-Control-Allow-Origin "*";
                add_header Access-Control-Allow-Methods "GET, POST, OPTIONS";
                add_header Access-Control-Allow-Headers "Content-Type, X-Correlation-ID";
                add_header Access-Control-Max-Age 86400;
                add_header Content-Length 0;
                add_header Content-Type text/plain;
                return 204;
            }
        }

        
	# Polygon.io Service - Proxy to internal service with comprehensive error handling
        location ~ ^/api/stock-services/polygonio($|/.*) {
            # Strip /polygonio prefix and pass everything else
            rewrite ^/api/stock-services/polygonio/?(.*)$ /$1 break;

            proxy_pass http://polygonio-api;
            proxy_redirect off;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Prefix /polygonio;

            # Pass correlation ID and request timing headers
            proxy_set_header X-Correlation-ID $http_x_correlation_id;
            proxy_set_header X-Request-Start $msec;
            proxy_set_header X-Service "polygonio-api";

            # Proxy timeouts and buffer settings
            proxy_connect_timeout 10s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
            proxy_buffering on;
            proxy_buffer_size 4k;
            proxy_buffers 8 4k;
            proxy_busy_buffers_size 8k;

            # Error handling - map upstream errors
            proxy_intercept_errors on;
            error_page 502 503 504 = @polygonio_error;

            # CORS headers for API access
            add_header Access-Control-Allow-Origin "*" always;
            add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
            add_header Access-Control-Allow-Headers "Content-Type, X-Correlation-ID" always;

            # Handle preflight requests
            if ($request_method = 'OPTIONS') {
                add_header Access-Control-Allow-Origin "*";
                add_header Access-Control-Allow-Methods "GET, POST, OPTIONS";
                add_header Access-Control-Allow-Headers "Content-Type, X-Correlation-ID";
                add_header Access-Control-Max-Age 86400;
                add_header Content-Length 0;
                add_header Content-Type text/plain;
                return 204;
            }
        }

	# Static documentation files (docsify)
        location /static-docs {
            alias /var/www/docs/;
            try_files $uri $uri/ $uri/index.html =404;
            index index.html;
        }

        # Web Terminal (Butterfly Python) - Redirect to Butterfly server
        location /terminal {
            return 301 http://localhost:7681;
        }

        # Error handler for Polygon.io service
        location @polygonio_error {
            internal;
            add_header Content-Type application/json always;
            add_header X-Correlation-ID $http_x_correlation_id always;
            
            if ($upstream_status = 502) {
                return 502 '{"error":{"type":"BadGateway","status":502,"message":"Polygon.io service is temporarily unavailable","source":"intermediary","correlation_id":"$http_x_correlation_id","retry_after":30}}';
            }
            if ($upstream_status = 503) {
                return 503 '{"error":{"type":"ServiceUnavailable","status":503,"message":"Polygon.io service is overloaded","source":"intermediary","correlation_id":"$http_x_correlation_id","retry_after":60}}';
            }
            if ($upstream_status = 504) {
                return 504 '{"error":{"type":"GatewayTimeout","status":504,"message":"Polygon.io service request timed out","source":"intermediary","correlation_id":"$http_x_correlation_id","retry_after":30}}';
            }
            
            return 500 '{"error":{"type":"InternalServerError","status":500,"message":"An unexpected error occurred","source":"intermediary","correlation_id":"$http_x_correlation_id"}}';
        }

        # Fallback to React for documentation routes that aren't files
        location @react_fallback {
            proxy_pass http://react-app:3001;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # React App - handle SPA routing (must be last)
        location / {
            proxy_pass http://react-app:3001/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_read_timeout 86400;
        }
    }

    # Server configuration for HOST_LAN_IP
    server {
        listen 80;
        server_name ${HOST_LAN_IP};

        # Security headers
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header Referrer-Policy "no-referrer-when-downgrade" always;
        add_header Content-Security-Policy "default-src 'self' http: https: data: blob: 'unsafe-inline' 'unsafe-eval'" always;
        
        # Timezone headers for UI timezone detection
        add_header X-Default-Timezone "America/Chicago" always;

        # Error pages
        error_page 404 /404.html;
        error_page 500 502 503 504 /50x.html;

        location = /404.html {
            return 404 '404 Not Found';
            add_header Content-Type text/plain;
        }

        location = /50x.html {
            return 500 '500 Internal Server Error';
            add_header Content-Type text/plain;
        }

        # CSS files - Adminer custom CSS
        location /adminer-custom.css {
            alias /var/www/css/adminer-custom.css;
            expires 7d;
            add_header Cache-Control "public";
            add_header Content-Type "text/css";
        }

        # API endpoints - Kafka Multi Messages API - Proxy to kafka-api service
        location /api/kafka/ {
            proxy_pass http://kafka-api:8000;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            add_header Access-Control-Allow-Origin "*";
            add_header Access-Control-Allow-Methods "GET, POST, OPTIONS";
            add_header Access-Control-Allow-Headers "Content-Type";
            proxy_read_timeout 60s;
            proxy_connect_timeout 10s;
        }

        # Metabase - analytics UI
        location /metabase/ {
            proxy_pass http://metabase/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header X-Forwarded-Prefix /metabase;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
        }

        # Health endpoint for Metabase
        location /metabase/health {
            proxy_pass http://metabase/api/health;
            proxy_set_header Host $host;
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Grafana - analytics and dashboards (proxy to Grafana container)
        location ~ ^/grafana($|/.*) {
            rewrite ^/grafana/?(.*)$ /$1 break;
            proxy_pass http://grafana;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Prefix /grafana;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
        }

        # Loki - log aggregation UI
        location ~ ^/loki($|/.*) {
            rewrite ^/loki/?(.*)$ /$1 break;
            proxy_pass http://loki;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Prefix /loki;
        }

        # Prometheus - metrics UI
        location ~ ^/prometheus($|/.*) {
            rewrite ^/prometheus/?(.*)$ /$1 break;
            proxy_pass http://prometheus;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Prefix /prometheus;
        }

        # Service control API (services-api: Butterfly, Docker, React App, Samba; Nginx cache-clear)
        location /api/service-control/ {
            proxy_pass http://service-control/;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_read_timeout 60s;
            proxy_connect_timeout 10s;
        }

        # Netdata - convenience redirect
        location = /netdata {
            return 301 /netdata/;
        }

        # Netdata - main UI and API
        location ~ ^/netdata/(?<ndpath>.*)$ {
            proxy_redirect off;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $host;
            proxy_http_version 1.1;
            proxy_set_header Connection "keep-alive";
            proxy_pass http://netdata/$ndpath$is_args$args;
            proxy_store off;
            proxy_buffering off;
            proxy_cache off;
        }

        # Polygon.io Service - Proxy to internal service with comprehensive error handling
        location ~ ^/api/polygonio($|/.*) {
            rewrite ^/api/polygonio/?(.*)$ /$1 break;
            proxy_pass http://polygonio-api;
            proxy_redirect off;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Prefix /polygonio;
            proxy_set_header X-Correlation-ID $http_x_correlation_id;
            proxy_set_header X-Request-Start $msec;
            proxy_set_header X-Service "polygonio-api";
            proxy_connect_timeout 10s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
            proxy_buffering on;
            proxy_buffer_size 4k;
            proxy_buffers 8 4k;
            proxy_busy_buffers_size 8k;
            proxy_intercept_errors on;
            error_page 502 503 504 = @polygonio_error;
            add_header Access-Control-Allow-Origin "*" always;
            add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
            add_header Access-Control-Allow-Headers "Content-Type, X-Correlation-ID" always;
            if ($request_method = 'OPTIONS') {
                add_header Access-Control-Allow-Origin "*";
                add_header Access-Control-Allow-Methods "GET, POST, OPTIONS";
                add_header Access-Control-Allow-Headers "Content-Type, X-Correlation-ID";
                add_header Access-Control-Max-Age 86400;
                add_header Content-Length 0;
                add_header Content-Type text/plain;
                return 204;
            }
        }

        # Polygon.io Service - stock-services/polygonio
        location ~ ^/api/stock-services/polygonio($|/.*) {
            rewrite ^/api/stock-services/polygonio/?(.*)$ /$1 break;
            proxy_pass http://polygonio-api;
            proxy_redirect off;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Prefix /polygonio;
            proxy_set_header X-Correlation-ID $http_x_correlation_id;
            proxy_set_header X-Request-Start $msec;
            proxy_set_header X-Service "polygonio-api";
            proxy_connect_timeout 10s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
            proxy_buffering on;
            proxy_buffer_size 4k;
            proxy_buffers 8 4k;
            proxy_busy_buffers_size 8k;
            proxy_intercept_errors on;
            error_page 502 503 504 = @polygonio_error;
            add_header Access-Control-Allow-Origin "*" always;
            add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
            add_header Access-Control-Allow-Headers "Content-Type, X-Correlation-ID" always;
            if ($request_method = 'OPTIONS') {
                add_header Access-Control-Allow-Origin "*";
                add_header Access-Control-Allow-Methods "GET, POST, OPTIONS";
                add_header Access-Control-Allow-Headers "Content-Type, X-Correlation-ID";
                add_header Access-Control-Max-Age 86400;
                add_header Content-Length 0;
                add_header Content-Type text/plain;
                return 204;
            }
        }

        # API endpoints - Docker API endpoints - Proxy to docker-api service
        location /api/docker/ {
            proxy_pass http://docker-api/api/docker/;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            add_header Access-Control-Allow-Origin "*";
            add_header Access-Control-Allow-Methods "GET, POST, OPTIONS";
            add_header Access-Control-Allow-Headers "Content-Type";
            proxy_read_timeout 120s;  # Longer timeout for build operations
            proxy_connect_timeout 10s;
        }

        # API endpoints - Kafka Topics API - Proxy to kafka-api service
        location = /api/kafka-topics {
            proxy_pass http://kafka-api:8000/api/kafka-topics;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            add_header Access-Control-Allow-Origin "*";
            add_header Access-Control-Allow-Methods "GET, POST, OPTIONS";
            add_header Access-Control-Allow-Headers "Content-Type";
            proxy_read_timeout 60s;
            proxy_connect_timeout 10s;
        }
        
        location /api/kafka-topics/ {
            proxy_pass http://kafka-api:8000/api/kafka-topics/;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            add_header Access-Control-Allow-Origin "*";
            add_header Access-Control-Allow-Methods "GET, POST, OPTIONS";
            add_header Access-Control-Allow-Headers "Content-Type";
            proxy_read_timeout 60s;
            proxy_connect_timeout 10s;
        }

        # API endpoints - Stock Services API - Proxy to kafka-api service
        location /api/stock-services {
            proxy_pass http://polygonio-api/api/stock-services;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            add_header Access-Control-Allow-Origin "*";
            add_header Access-Control-Allow-Methods "GET, POST, OPTIONS";
            add_header Access-Control-Allow-Headers "Content-Type";
            proxy_read_timeout 60s;
            proxy_connect_timeout 10s;
        }

        # cAdvisor - Proxy to internal service
        location /cadvisor {
            proxy_pass http://cadvisor/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # CSS files - Static file serving for custom CSS files
        location /css/ {
            alias /var/www/css/;
            expires 7d;
            add_header Cache-Control "public";
            add_header Access-Control-Allow-Origin "*";
            add_header Content-Type "text/css";
        }

        # Health check
        location /health {
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }

        # React routing - handle health-dashboard and internal React routes
        location ~ ^/(health-dashboard)(/.*)?$ {
            proxy_pass http://react-app:3001;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }

        # Icons - Static file serving for icons
        location /icons/ {
            alias /var/www/icons/;
            expires 7d;
            add_header Cache-Control "public";
            add_header Access-Control-Allow-Origin "*";
        }

        # Kafka - Proxy to internal service
        location /kafka {
            proxy_pass http://kafka/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Kafka UI - completely new simple approach
        location ~ ^/kafka($|/.*) {
            # Strip /kafka prefix and pass everything else
            rewrite ^/kafka/?(.*)$ /$1 break;
            
            proxy_pass http://kafka-ui;
            proxy_redirect off;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Prefix /kafka;
            
            # Disable compression for sub_filter
            proxy_set_header Accept-Encoding "";
            
            # Inject our custom CSS into Kafka UI pages
            sub_filter '</head>' '<link rel="stylesheet" type="text/css" href="/css/kafka-custom.css"></head>';
            
            # Rewrite asset paths in HTML
            sub_filter 'window.basePath = \'\';' 'window.basePath = \'/kafka\';';
            sub_filter '="/assets/' '="/kafka/assets/';
            sub_filter "url('/fonts/" "url('/kafka/fonts/";
            
            sub_filter_once off;
        }

        # CSS files - Kafka custom CSS
        location /kafka-custom.css {
            alias /var/www/css/kafka-custom.css;
            expires 7d;
            add_header Cache-Control "public";
            add_header Content-Type "text/css";
        }

        # MySQL Database Admin UI - Simple proxy to Adminer with CSS injection
        location ~ ^/mysql($|/.*) {
            # Strip /mysql prefix and pass everything else
            rewrite ^/mysql/?(.*)$ /$1 break;
            
            proxy_pass http://adminer;
            proxy_redirect off;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Prefix /mysql;
            
            # Disable compression for sub_filter
            proxy_set_header Accept-Encoding "";
            
            # Inject our custom CSS into Adminer pages
            sub_filter '</head>' '<link rel="stylesheet" type="text/css" href="/css/adminer-custom.css"></head>';
            
            # Rewrite asset paths in HTML for Adminer
            sub_filter '="/' '="/mysql/';
            sub_filter "url('/" "url('/mysql/";
            sub_filter 'href="/' 'href="/mysql/';
            sub_filter 'src="/' 'src="/mysql/';
            sub_filter_once off;
        }

        # Polygon.io Service - Proxy to internal service with comprehensive error handling
        location ~ ^/polygonio($|/.*) {
            # Strip /polygonio prefix and pass everything else
            rewrite ^/polygonio/?(.*)$ /$1 break;
            
            proxy_pass http://polygonio-api;
            proxy_redirect off;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Prefix /polygonio;
            
            # Pass correlation ID and request timing headers
            proxy_set_header X-Correlation-ID $http_x_correlation_id;
            proxy_set_header X-Request-Start $msec;
            proxy_set_header X-Service "polygonio-api";
            
            # Proxy timeouts and buffer settings
            proxy_connect_timeout 10s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
            proxy_buffering on;
            proxy_buffer_size 4k;
            proxy_buffers 8 4k;
            proxy_busy_buffers_size 8k;
            
            # Error handling - map upstream errors
            proxy_intercept_errors on;
            error_page 502 503 504 = @polygonio_error;
            
            # CORS headers for API access
            add_header Access-Control-Allow-Origin "*" always;
            add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
            add_header Access-Control-Allow-Headers "Content-Type, X-Correlation-ID" always;
            
            # Handle preflight requests
            if ($request_method = 'OPTIONS') {
                add_header Access-Control-Allow-Origin "*";
                add_header Access-Control-Allow-Methods "GET, POST, OPTIONS";
                add_header Access-Control-Allow-Headers "Content-Type, X-Correlation-ID";
                add_header Access-Control-Max-Age 86400;
                add_header Content-Length 0;
                add_header Content-Type text/plain;
                return 204;
            }
        }

        # Docsify documentation - serve all files under /docs via docsify-server
        location /docs/ {
            # Strip /docs prefix and pass everything else
            rewrite ^/docs/?(.*)$ /$1 break;
            proxy_pass http://docsify-server/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Prefix /docs;
        }
        location = /docs {
            return 301 /docs/;
        }

        # Swagger API documentation routing.  Each API exposes its own OpenAPI
        # documentation at /docs.  We proxy these paths under /api-docs/{service}
        # to the appropriate internal service.
        location /api-docs/docker/ {
            rewrite ^/api-docs/docker/?(.*)$ /$1 break;
            proxy_pass http://docker-api/docs/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Prefix /api-docs/docker;
        }
        location /api-docs/kafka/ {
            rewrite ^/api-docs/kafka/?(.*)$ /$1 break;
            proxy_pass http://kafka-api:8000/docs/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Prefix /api-docs/kafka;
        }
        location /api-docs/db/ {
            rewrite ^/api-docs/db/?(.*)$ /$1 break;
            proxy_pass http://db-api:8000/docs/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Prefix /api-docs/db;
        }
        location /api-docs/polygonio/ {
            rewrite ^/api-docs/polygonio/?(.*)$ /$1 break;
            proxy_pass http://polygonio-api/docs/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Prefix /api-docs/polygonio;
        }

        # Static documentation files (docsify)
        location /static-docs {
            alias /var/www/docs/;
            try_files $uri $uri/ $uri/index.html =404;
            index index.html;
        }

        # Web Terminal (Butterfly Python) - Redirect to Butterfly server
        location /terminal {
            return 301 http://localhost:7681;
        }

        # Error handler for Polygon.io service
        location @polygonio_error {
            internal;
            add_header Content-Type application/json always;
            add_header X-Correlation-ID $http_x_correlation_id always;
            
            if ($upstream_status = 502) {
                return 502 '{"error":{"type":"BadGateway","status":502,"message":"Polygon.io service is temporarily unavailable","source":"intermediary","correlation_id":"$http_x_correlation_id","retry_after":30}}';
            }
            if ($upstream_status = 503) {
                return 503 '{"error":{"type":"ServiceUnavailable","status":503,"message":"Polygon.io service is overloaded","source":"intermediary","correlation_id":"$http_x_correlation_id","retry_after":60}}';
            }
            if ($upstream_status = 504) {
                return 504 '{"error":{"type":"GatewayTimeout","status":504,"message":"Polygon.io service request timed out","source":"intermediary","correlation_id":"$http_x_correlation_id","retry_after":30}}';
            }
            
            return 500 '{"error":{"type":"InternalServerError","status":500,"message":"An unexpected error occurred","source":"intermediary","correlation_id":"$http_x_correlation_id"}}';
        }

        # Fallback to React for documentation routes that aren't files
        location @react_fallback {
            proxy_pass http://react-app:3001;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # React App - handle SPA routing (must be last)
        location / {
            proxy_pass http://react-app:3001/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_read_timeout 86400;
        }
    }
}
